# RongheDraw 多模式绘图插件

> AstrBot 绘图插件，支持 Flow/Generic/Gemini 三种 API 模式

**作者**: Antigravity  
**版本**: 1.0.1

---

## ✨ 功能特点

- 🔀 **三种 API 模式**：Flow / Generic / Gemini (4K)
- 🎨 **文生图 & 图生图**：支持多图输入
- 📐 **智能模型选择**：Flow模式根据图片比例自动选择横版/竖版模型
- 🌐 **翻译功能**：Flow 模式支持中英翻译
- 👥 **权限管理**：白名单用户/群聊分级权限
- ⏳ **并发控制**：每模式同时只允许1个非白名单用户生成
- 🎲 **预设效果**：9个内置预设 + 自定义预设
- 🤖 **LLM 工具**：让 AI 调用绘图功能
- 📦 **图片压缩**：自动压缩大图避免 API 错误
- 🔒 **隐私保护**：自动过滤@用户的昵称和QQ号

---

## 🚀 快速开始

### 安装

1. 将 `astrbot_plugin_ronghedraw` 文件夹放入 AstrBot 的 `plugins` 目录
2. 安装依赖：`pip install -r requirements.txt`

> 💡 插件启动时会自动检测依赖，缺少时会输出提醒

### 配置

在 AstrBot 管理面板中配置：

1. **Flow 模式**：`flow_api_url`、`flow_api_key`、`flow_default_model`
2. **Generic 模式**：`generic_api_url`、`generic_api_keys`
3. **Gemini 模式**：`gemini_api_url`、`gemini_api_keys`、`gemini_resolution` (默认4K)

---

## 📝 命令列表

### 文生图
| 命令 | 说明 |
|------|------|
| `#f文 <描述>` | Flow 模式文生图（自动横竖版） |
| `#o文 <描述>` | Generic 模式文生图 |
| `#g文 <描述>` | Gemini 模式文生图 (4K) |
| `#文生图 <描述>` | 默认模式 |

### 图生图
| 命令 | 说明 |
|------|------|
| `#f图 [图片]` | Flow 模式（自动横竖版） |
| `#o图 [图片]` | Generic 模式 |
| `#g图 [图片]` | Gemini 模式 (4K) |
| `#图生图 [图片]` | 默认模式 |

### 随机预设
| 命令 | 说明 |
|------|------|
| `#f随机 [图片]` | Flow 模式随机 |
| `#o随机 [图片]` | Generic 模式随机 |
| `#g随机 [图片]` | Gemini 模式随机 |
| `#随机 [图片]` | 默认模式随机 |

> 注：随机预设使用配置中的 `prompt_list` 自定义预设

### 管理
| 命令 | 说明 |
|------|------|
| `#查询次数` | 查询今日剩余 |
| `#预设列表` | 查看自定义预设 |
| `#生图菜单` | 显示完整菜单 |
| `#生图帮助` | 显示帮助 |
| `#f切换模型` | 切换 Flow 模型 |
| `#f翻译开关` | 翻译功能开关 |

---

## 👥 权限系统

| 用户类型 | 可用模式 | 次数限制 | 并发限制 |
|----------|----------|----------|----------|
| 白名单用户 | 全部 (f/o/g) | ❌ 无限制 | ❌ 无限制 |
| 白名单群聊 | 全部 (f/o/g) | ✅ 有限制 | ✅ 有限制 |
| 普通用户 | 仅 f 模式 | ✅ 有限制 | ✅ 每模式1个 |

---

## ⚙️ 配置说明

### Flow 模式配置
- `flow_api_url`: API 地址（OpenAI 格式）
- `flow_api_key`: API 密钥
- `flow_default_model`: 默认模型（横版，自动切换竖版）
- `flow_model_list`: 可切换的模型列表
- `flow_enable_translate`: 启用翻译
- `flow_use_proxy`: 启用代理

### Generic 模式配置
- `generic_api_url`: API 地址
- `generic_api_keys`: API Key 池
- `generic_default_model`: 默认模型
- `generic_use_proxy`: 启用代理

### Gemini 模式配置
- `gemini_api_url`: Google API 地址
- `gemini_api_keys`: API Key 池
- `gemini_default_model`: 默认模型（gemini-3-pro-image-preview）
- `gemini_resolution`: 输出分辨率 (1K/2K/4K，默认4K)
- `gemini_use_proxy`: 启用代理（默认开启）

### 代理配置
- `proxy_url`: 代理地址（默认: http://172.17.0.1:7890）

### 自定义预设
- `prompt_list`: 预设列表，格式: `["触发词:提示词内容"]`

---

## 📦 依赖

```
aiohttp>=3.8.0
Pillow>=9.0.0
```

---

## 📜 更新日志

### v1.0.1
- 修复: Flow模式自动选择横版/竖版模型
- 修复: Gemini 4K分辨率输出
- 修复: @用户信息泄露问题
- 修复: Generic模式"Chunk too big"错误（添加图片压缩）
- 优化: 代理默认设置为 http://172.17.0.1:7890
- 优化: 命令重命名（生图菜单/生图帮助/预设列表）
- 优化: 启动时自动检测依赖
- 移除: 内置预设，改用配置自定义预设

### v1.0.0
- 首次发布

---

## 🤖 LLM对话式绘图

本插件支持通过AI对话自然绘图，无需记忆指令。

### 配置要求

1. 在AstrBot中启用 `enable_llm_tool`
2. 确保至少有一个绘图模式已启用

### 使用示例

**文生图**：
```
用户：画一只可爱的猫
AI：好的，我来画~ [调用绘图工具]
```

**图生图（需要用户提供图片URL）**：
```
用户：把这张图改成二次元风格
AI：请提供图片链接
用户：https://example.com/image.jpg
AI：收到！[调用绘图工具，基于该图片]
```

**使用头像绘图**：
```
用户：用我的头像画个手办
AI：好哦~ [先获取用户头像URL，再调用绘图工具]
```

### 次数统计

- LLM绘图使用**群级统计**（可配置）
- 默认每群每天10次（白名单群不限）
- 与指令绘图次数（个人统计）分开

### 人格定制建议

如果你的AI人格不是默认的，建议在系统提示中增加以下引导（可选）：

```
你有绘图能力（generate_image工具）。适度使用，建议一次对话主动绘图不超过1-2次。
画图消耗群额度，请节制。
```

根据你的人格风格调整措辞即可。

---

## 📄 许可证

MIT License
